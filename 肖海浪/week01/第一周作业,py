import jieba #中文分词
import pandas as pd
from openai import OpenAI
from sklearn.feature_extraction.text import CountVectorizer
from sklearn.neighbors import KNeighborsClassifier

dataset = pd.read_csv("dataset.csv", sep="\t", header=None, nrows=10000)

# 提取 文本的特征 tfidf， dataset[0]
# 构建一个模型 knn， 学习 提取的特征和 标签 dataset[1] 的关系
# 预测，用户输入的一个文本，进行预测结果
input_sententce = dataset[0].apply(lambda x: " ".join(jieba.lcut(x))) # sklearn对中文处理

vector = CountVectorizer() # 对文本进行提取特征 默认是使用标点符号分词， 不是模型
vector.fit(input_sententce.values) # 统计词表
input_feature = vector.transform(input_sententce.values) # 100 * 词表大小

model = KNeighborsClassifier()
model.fit(input_feature, dataset[1].values)
#print(model)

client = OpenAI(
    # 若没有配置环境变量，请用百炼API Key将下行替换为：api_key="sk-xxx",
    # https://bailian.console.aliyun.com/?tab=model#/api-key
    api_key="sk-d342b662f6ed4ee2af999c15a6b3c549", # 账号绑定，用来计费的

    # 大模型厂商的地址，阿里云
    base_url="https://dashscope.aliyuncs.com/compatible-mode/v1",
)

def text_calssify_using_ml(test_query: str) -> str:
    """
    文本分类(机器学习),输出文本完成类别划分
    """
    test_sentence = " ".join(jieba.lcut(test_query))
    test_feature = vector.transform([test_sentence])
    return model.predict(test_feature)[0]


def text_calssify_using_llm(text: str) -> str:
    """
    文本分类(大语言模型),输出文本完成类别划分
    """
    completion = client.chat.completions.create(
        # 模型列表：https://help.aliyun.com/zh/model-studio/getting-started/models
        model="qwen-flash",  # 模型的代号

        # 对话列表
        messages=[
            {"role": "user", "content": f"""帮我进行文本分类:{text},
            输出的文本类别只能从以下进行选择:
            FilmTele-Play            
            Video-Play               
            Music-Play               
            Radio-Listen             
            Alarm-Update             
            Weather-Query            
            Travel-Query             
            HomeAppliance-Control    
            Calendar-Query           
            TVProgram-Play           
            Audio-Play                
            Other
            """}  # 用户的提问
        ]
    )
    return completion.choices[0].message.content

if __name__ == "__main__":
    # pandas 用来进行表格的加载和分析
    # numpy 从矩阵的角度来惊喜加载和计算
    print("这是机器学习:")
    print(text_calssify_using_ml("今天我真的很开心"))
    print(text_calssify_using_ml("帮我导航到广州塔"))
    print("这是大语言模型:")
    print(text_calssify_using_llm("今天我真的很开心"))
    print(text_calssify_using_llm("帮我导航到广州塔"))
